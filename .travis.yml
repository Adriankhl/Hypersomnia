os: linux
language: cpp
sudo: required
dist: trusty
addons:
  apt:
    packages:
     - gdb
     - apport
     - gcc-7
     - g++-7
     - clang-7
     - lld-7
     - libc++-7-dev
     - libc++abi-7-dev
     - cmake
     - ninja-build
     - libxcb-keysyms1
     - libxcb-keysyms1-dev
     - libxi6
     - libxi-dev
     - alsa-oss
     - osspd-alsa
     - osspd
     - libasound2
     - libasound2-dev
    sources:
     - ubuntu-toolchain-r-test
     - llvm-toolchain-trusty-7

python:
  - "3.6"

matrix:
  include:
  - env: c_compiler=clang-7 cxx_compiler=clang++-7 config=Release other_cmake_flags=""
    compiler: clang-7
#  - env: c_compiler=gcc-7 cxx_compiler=g++-7 config=Debug other_cmake_flags=""
#    compiler: gcc
#  - env: c_compiler=gcc-7 cxx_compiler=g++-7 config=RelWithDebInfo other_cmake_flags=""
#    compiler: gcc

before_install:
 - ulimit -c
 - ulimit -a -S
 - ulimit -a -H
 - cat /proc/sys/kernel/core_pattern
 - cat /etc/default/apport
 - service --status-all || true
 - initctl list || true

script:
  - ${c_compiler} -v && ${cxx_compiler} -v && cmake --version && make --version && python --version
  - export CC=${c_compiler}
  - export CXX=${cxx_compiler}
  - cmake/build.sh ${config} x64 "${other_cmake_flags}"
  - ulimit -c unlimited -S
  - pushd build/current
  - ninja tests -k 0
  - ls -l
  - popd
  - ls -l hypersomnia
  - cmake/print_bt_if_core_found.sh hypersomnia/core

notfications:
  email: false
